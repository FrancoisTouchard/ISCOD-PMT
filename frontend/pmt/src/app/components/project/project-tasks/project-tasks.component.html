<div>
  <div *ngIf="tasks.length > 0" class="table-responsive mt-3">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th style="width: 15%">Nom</th>
          <th style="width: 20%">Description</th>
          <th style="min-width: 10%" class="text-center">
            <div class="d-inline-flex align-items-center gap-1">
              Statut
              <div ngbDropdown class="d-inline-block position-static">
                <button
                  class="btn btn-sm btn-outline-light border-0 p-0 ps-1 pe-1 ms-1"
                  ngbDropdownToggle
                  title="Filtrer par statut"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    fill="currentColor"
                    class="bi bi-filter"
                    viewBox="0 0 16 16"
                  >
                    <path
                      d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5m-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5"
                    />
                  </svg>
                </button>

                <div ngbDropdownMenu>
                  <button ngbDropdownItem (click)="setStatusFilter('ALL')">
                    Tous les statuts
                  </button>
                  <button
                    ngbDropdownItem
                    *ngFor="let status of statusList"
                    (click)="setStatusFilter(status)"
                  >
                    {{ getStatusLabel(status).label }}
                  </button>
                </div>
              </div>
            </div>
          </th>
          <th style="width: 10%" class="text-center">Priorité</th>
          <th style="width: 10%" class="text-center">Échéance</th>
          <th style="width: 10%" class="text-center">Date de fin</th>
          <th style="width: 10%">Assigné à</th>
          <th style="width: 15%" class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let task of filteredTasks">
          <td
            class="text-truncate fw-semibold"
            style="max-width: 150px"
            [title]="task.name"
          >
            {{ task.name }}
          </td>
          <td
            class="text-truncate"
            style="max-width: 200px"
            [title]="task.description || ''"
          >
            {{ task.description || "-" }}
          </td>
          <td class="text-center">
            <span
              class="badge"
              [ngStyle]="{
                'background-color': getStatusLabel(task.status).color
              }"
            >
              {{ getStatusLabel(task.status).label }}
            </span>
          </td>
          <td class="text-center">
            <span
              class="badge"
              [ngStyle]="{
                'background-color': getPriorityLabel(task.priority).color
              }"
            >
              {{ getPriorityLabel(task.priority).label }}
            </span>
          </td>
          <td class="text-center">
            {{ task.dueDate | date : "dd/MM/yyyy" }}
          </td>
          <td class="text-center">
            {{ task.endDate ? (task.endDate | date : "dd/MM/yyyy") : "-" }}
          </td>
          <td
            class="text-truncate"
            style="max-width: 120px"
            [title]="getAssigneesNames(task)"
          >
            <span
              class="text-muted fst-italic"
              *ngIf="!getAssigneesNames(task)"
            >
              Non assigné
            </span>
            <span *ngIf="getAssigneesNames(task)">
              {{ getAssigneesNames(task) }}
            </span>
          </td>
          <td class="text-center">
            <div class="btn-group btn-group-sm" role="group">
              <button
                class="btn btn-primary"
                (click)="viewTask(task)"
                title="Voir les détails"
              >
                Voir
              </button>
              <button
                class="btn btn-secondary ms-2 me-2"
                (click)="openHistoryModal(task)"
                title="Voir l'historique"
              >
                Historique
              </button>
              <button
                class="btn btn-danger"
                (click)="onTaskDeleted(task)"
                title="Supprimer la tâche"
              >
                Supprimer
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Empty screen tâches -->
  <div
    *ngIf="tasks.length === 0"
    class="alert alert-info d-flex flex-column align-items-center mt-4"
  >
    <div>
      <strong>Aucune tâche</strong> - Vous n'avez aucun projet pour le moment.
    </div>
    <button class="btn btn-primary mt-2" (click)="openModal()">
      Créer une tâche
    </button>
  </div>
</div>

<app-task-modal
  [isOpen]="isModalOpen"
  [mode]="modalMode"
  [task]="selectedTask"
  [project]="project"
  (closed)="closeModal()"
  (saved)="onTaskSaved($event)"
></app-task-modal>

<app-history-modal
  [isOpen]="isHistoryModalOpen"
  [taskName]="selectedTask?.name"
  [historyEntries]="selectedTaskHistory"
  [loading]="loadingHistory"
  (closed)="closeHistoryModal()"
></app-history-modal>
