<nav class="navbar header bg-primary">
  <div class="container-fluid">
    <div>
      <button class="btn btn-danger" (click)="logOut()">Déconnexion</button>
      <button class="btn btn-light" (click)="goToHomePage()">
        Mes Projets
      </button>
    </div>
  </div>
</nav>

<!-- Chargement -->
<div *ngIf="loading" class="text-center mt-4">
  <div class="spinner-border" role="status">
    <span class="visually-hidden">Chargement...</span>
  </div>
</div>

<div *ngIf="!loading" class="container mt-4">
  <h1 class="mb-4">{{ project?.name }}</h1>
  <h2 class="mb-4">{{ project?.description }}</h2>

  <!-- Boutons d'ajout -->
  <div class="mb-4 d-flex justify-content-start">
    <button
      class="btn btn-primary"
      *ngIf="
        (currentUserRole === 'ADMINISTRATEUR' ||
          currentUserRole === 'MEMBRE') &&
        activeTab === 'tasks'
      "
      (click)="openTaskModalFromParent()"
    >
      + Ajouter une tâche
    </button>

    <button
      class="btn btn-primary"
      *ngIf="currentUserRole === 'ADMINISTRATEUR' && activeTab === 'members'"
      (click)="showAddContributorBlock()"
    >
      + Ajouter un contributeur
    </button>
  </div>

  <!-- Form d'ajout de contributeur -->
  <div
    *ngIf="isMemberModalOpen"
    class="modal-overlay"
    (click)="closeMemberModal()"
  >
    <div class="modal-dialog" (click)="$event.stopPropagation()">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Ajouter un contributeur</h5>
          <button
            type="button"
            class="btn-close"
            (click)="closeMemberModal()"
          ></button>
        </div>

        <div class="modal-body">
          <form
            [formGroup]="addContributorForm"
            (ngSubmit)="onContributorAdded()"
          >
            <div formGroupName="contributorData">
              <!-- Email -->
              <div class="mb-3">
                <label class="form-label" for="email">Email*</label>
                <input
                  id="email"
                  class="form-control"
                  formControlName="email"
                  placeholder="exemple@mail.com"
                  required
                />
                <div
                  *ngIf="email.hasError('required') && email.touched"
                  class="text-danger mt-1"
                >
                  L'email est requis
                </div>
                <div
                  *ngIf="email.hasError('email') && email.touched"
                  class="text-danger mt-1"
                >
                  Le format d'email n'est pas bon
                </div>
              </div>

              <!-- Role -->
              <div class="mb-3">
                <label class="form-label" for="role">Rôle</label>
                <select id="role" class="form-select" formControlName="role">
                  <option [value]="Role.ADMINISTRATEUR">
                    {{ getRoleLabel(Role.ADMINISTRATEUR).label }}
                  </option>
                  <option [value]="Role.MEMBRE">
                    {{ getRoleLabel(Role.MEMBRE).label }}
                  </option>
                  <option [value]="Role.OBSERVATEUR">
                    {{ getRoleLabel(Role.OBSERVATEUR).label }}
                  </option>
                </select>
              </div>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            type="button"
            (click)="closeMemberModal()"
          >
            Annuler
          </button>
          <button
            class="btn btn-primary"
            type="submit"
            (click)="onContributorAdded()"
          >
            Ajouter
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Onglets -->
  <ul class="nav nav-tabs" id="projectTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        [class.active]="activeTab === 'tasks'"
        id="taches-tab"
        data-bs-toggle="tab"
        data-bs-target="#taches"
        type="button"
        role="tab"
        aria-controls="taches"
        [attr.aria-selected]="activeTab === 'tasks'"
        (click)="setActiveTab('tasks')"
      >
        Tâches
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        [class.active]="activeTab === 'members'"
        id="membres-tab"
        data-bs-toggle="tab"
        data-bs-target="#membres"
        type="button"
        role="tab"
        aria-controls="membres"
        [attr.aria-selected]="activeTab === 'members'"
        (click)="setActiveTab('members')"
      >
        Membres
      </button>
    </li>
  </ul>

  <div class="tab-content" id="projectTabsContent">
    <!-- Onglet Tâches -->
    <div
      class="tab-pane fade"
      [class.show]="activeTab === 'tasks'"
      [class.active]="activeTab === 'tasks'"
      id="tasks"
      role="tabpanel"
      aria-labelledby="tasks-tab"
    >
      <app-project-tasks
        #tasksComponent
        *ngIf="activeTab === 'tasks'"
        [loading]="loading"
        [project]="project"
        [tasks]="tasks"
        [currentUserRole]="currentUserRole!"
        (taskAdded)="onTaskAdded($event)"
        (taskUpdated)="onTaskUpdated($event)"
        (taskDeleted)="onTaskDeleted($event)"
      ></app-project-tasks>
    </div>

    <!-- Onglet Membres -->
    <div
      class="tab-pane fade"
      [class.show]="activeTab === 'members'"
      [class.active]="activeTab === 'members'"
      id="members"
      role="tabpanel"
      aria-labelledby="members-tab"
    >
      <app-project-members
        *ngIf="activeTab === 'members'"
        [project]="project"
        [currentUserRole]="currentUserRole"
        [showAddForm]="isMemberModalOpen"
        (contributorDeleted)="onContributorDeleted($event)"
        (contributorRoleUpdated)="onContributorRoleUpdated($event)"
        (formClosed)="isMemberModalOpen = false"
      ></app-project-members>
    </div>
  </div>
</div>
